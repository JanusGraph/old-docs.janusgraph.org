<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;7.&nbsp;JanusGraph Server</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="JanusGraph Documentation"><link rel="up" href="basics.html" title="Part&nbsp;II.&nbsp;JanusGraph Basics"><link rel="prev" href="gremlin.html" title="Chapter&nbsp;6.&nbsp;Gremlin Query Language"><link rel="next" href="deployment-scenarios.html" title="Chapter&nbsp;8.&nbsp;Deployment Scenarios"><script xmlns:d="http://docbook.org/ns/docbook" type="text/javascript" src="js/jquery/jquery-1.11.0.js"></script><script xmlns:d="http://docbook.org/ns/docbook" type="text/javascript" src="js/jquery/jquery-migrate-1.2.1.min.js"></script><link xmlns:d="http://docbook.org/ns/docbook" rel="stylesheet" id="inline-blob-janusgraph-docs-specific" href="css/docs.css" type="text/css" media="all"><link xmlns:d="http://docbook.org/ns/docbook" rel="apple-touch-icon" type="image/png" href="images/janusgraph-logomark.png"><script xmlns:d="http://docbook.org/ns/docbook" type="text/javascript">
      WebFontConfig = {
        google: {
          families: [
            "Lato:400,400italic,700,700italic:latin,greek-ext,cyrillic,latin-ext,greek,cyrillic-ext,vietnamese",
            "Open+Sans:400,400italic,700,700italic:latin,greek-ext,cyrillic,latin-ext,greek,cyrillic-ext,vietnamese",
            "Antic+Slab:400,400italic,700,700italic:latin,greek-ext,cyrillic,latin-ext,greek,cyrillic-ext,vietnamese"
          ]
        }
      };
      (function() {
      var wf = document.createElement('script');
      wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
        '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
	wf.type = 'text/javascript';
	wf.async = 'true';
	var s = document.getElementsByTagName('script')[0];
	s.parentNode.insertBefore(wf, s);
	})();
    </script></head><body xmlns:d="http://docbook.org/ns/docbook" bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div id="wrapper"><div class="header-wrapper"><header id="header"><ul class="header-list"><li class="header-item"><a href="http://janusgraph.org"><img src="images/janusgraph-logo.png" alt="JanusGraph" class="normal_logo"></a></li><li class="header-item-right"><a href="https://github.com/JanusGraph/janusgraph/releases">Download JanusGraph</a></li><li class="header-item-right dropdown"><a href="https://docs.janusgraph.org/latest/doc-versions.html">Other Doc Versions</a><div class="dropdown-content"><a href="https://docs.janusgraph.org/latest/index.html">Latest</a><a href="https://docs.janusgraph.org/0.3.1/index.html">Version 0.3.1</a><a href="https://docs.janusgraph.org/0.3.0/index.html">Version 0.3.0</a><a href="https://docs.janusgraph.org/0.2.2/index.html">Version 0.2.2</a><a href="https://docs.janusgraph.org/0.2.1/index.html">Version 0.2.1</a><a href="https://docs.janusgraph.org/0.2.0/index.html">Version 0.2.0</a><a href="https://docs.janusgraph.org/0.1.1/index.html">Version 0.1.1</a><a href="https://docs.janusgraph.org/0.1.0/index.html">Version 0.1.0</a></div></li><li class="header-item-right"><a href="index.html">Documentation (0.3.1)</a></li></ul></header></div><div id="main" class="clearfix width-100"><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">JanusGraph Documentation</a></span> &gt; <span class="breadcrumb-link"><a href="basics.html">JanusGraph Basics</a></span> &gt; <span class="breadcrumb-node">JanusGraph Server</span></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="server"></a>Chapter&nbsp;7.&nbsp;JanusGraph Server</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="server.html#server-getting-started">7.1. Getting Started</a></span></dt><dd><dl><dt><span class="section"><a href="server.html#_using_the_pre_packaged_distribution">7.1.1. Using the Pre-Packaged Distribution</a></span></dt></dl></dd><dt><span class="section"><a href="server.html#_cleaning_up_after_the_pre_packaged_distribution">7.2. Cleaning up after the Pre-Packaged Distribution</a></span></dt><dt><span class="section"><a href="server.html#_janusgraph_server_as_a_websocket_endpoint">7.3. JanusGraph Server as a WebSocket Endpoint</a></span></dt><dt><span class="section"><a href="server.html#_janusgraph_server_as_a_http_endpoint">7.4. JanusGraph Server as a HTTP Endpoint</a></span></dt><dt><span class="section"><a href="server.html#_janusgraph_server_as_both_a_websocket_and_http_endpoint">7.5. JanusGraph Server as Both a WebSocket and HTTP Endpoint</a></span></dt><dt><span class="section"><a href="server.html#_advanced_janusgraph_server_configurations">7.6. Advanced JanusGraph Server Configurations</a></span></dt><dd><dl><dt><span class="section"><a href="server.html#_authentication_over_http">7.6.1. Authentication over HTTP</a></span></dt><dt><span class="section"><a href="server.html#_authentication_over_websocket">7.6.2. Authentication over WebSocket</a></span></dt><dt><span class="section"><a href="server.html#_authentication_over_http_and_websocket">7.6.3. Authentication over HTTP and WebSocket</a></span></dt><dt><span class="section"><a href="server.html#gremlin-server-with-janusgraph">7.6.4. Using TinkerPop Gremlin Server with JanusGraph</a></span></dt></dl></dd><dt><span class="section"><a href="server.html#_extending_janusgraph_server">7.7. Extending JanusGraph Server</a></span></dt></dl></div><p>JanusGraph uses the <a class="link" href="http://tinkerpop.apache.org/docs/3.3.3/reference#gremlin-server" target="_top">Gremlin Server</a> engine as the server component to process and answer client queries.  When packaged in JanusGraph, Gremlin Server is called JanusGraph Server.</p><p>JanusGraph Server must be started manually in order to use it.  JanusGraph Server provides a way to remotely execute Gremlin scripts against one or more JanusGraph instances hosted within it. This section will describe how to use the WebSocket configuration, as well as describe how to configure JanusGraph Server to handle HTTP endpoint interactions.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="server-getting-started"></a>7.1.&nbsp;Getting Started</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_using_the_pre_packaged_distribution"></a>7.1.1.&nbsp;Using the Pre-Packaged Distribution</h3></div></div></div><p>The JanusGraph <a class="link" href="https://github.com/JanusGraph/janusgraph/releases" target="_top">release</a> comes pre-configured to run JanusGraph Server out of the box leveraging a sample Cassandra and Elasticsearch configuration to allow users to get started quickly with JanusGraph Server.  This configuration defaults to client applications that can connect to JanusGraph Server via WebSocket with a custom subprotocol.  There are a number of clients developed in different languages to help support the subprotocol.  The most familiar client to use the WebSocket interface is the Gremlin Console. The quick-start bundle is not intended to be representative of a production installation, but does provide a way to perform development with JanusGraph Server, run tests and see how the components are wired together. To use this default configuration:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Download a copy of the current <code class="literal">janusgraph-$VERSION.zip</code> file from the <a class="link" href="https://github.com/JanusGraph/janusgraph/releases" target="_top">Releases page</a></li><li class="listitem">Unzip it and enter the <code class="literal">janusgraph-$VERSION</code> directory</li><li class="listitem">Run <code class="literal">bin/janusgraph.sh start</code>.  This step will start Gremlin Server with Cassandra/ES forked into a separate process. Note for security reasons Elasticsearch and therefore <code class="literal">janusgraph.sh</code> must be run under a non-root account.</li></ul></div><pre class="programlisting">$ bin/janusgraph.sh start
Forking Cassandra...
Running `nodetool statusthrift`.. OK (returned <strong class="hl-keyword">exit</strong> status <span class="hl-number">0</span> and printed string <span class="hl-string">"running"</span>).
Forking Elasticsearch...
Connecting to Elasticsearch (<span class="hl-number">127.0</span>.<span class="hl-number">0.1</span>:<span class="hl-number">9300</span>)... OK (connected to <span class="hl-number">127.0</span>.<span class="hl-number">0.1</span>:<span class="hl-number">9300</span>).
Forking Gremlin-Server...
Connecting to Gremlin-Server (<span class="hl-number">127.0</span>.<span class="hl-number">0.1</span>:<span class="hl-number">8182</span>)... OK (connected to <span class="hl-number">127.0</span>.<span class="hl-number">0.1</span>:<span class="hl-number">8182</span>).
Run gremlin.sh to connect.</pre><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="first-example-connecting-gremlin-server"></a>7.1.1.1.&nbsp;Connecting to Gremlin Server</h4></div></div></div><p>After running <code class="literal">janusgraph.sh</code>, Gremlin Server will be ready to listen for WebSocket connections.  The easiest way to test the connection is with Gremlin Console.</p><p>Start <a class="link" href="http://tinkerpop.apache.org/docs/3.3.3/reference#gremlin-console" target="_top">Gremlin Console</a> with <code class="literal">bin/gremlin.sh</code> and use the <code class="literal">:remote</code> and <code class="literal">:&gt;</code> commands to issue Gremlin to Gremlin Server:</p><pre class="programlisting">$  bin/gremlin.sh
         \,,,/
         (o o)
-----oOOo-(3)-oOOo-----
plugin activated: tinkerpop.server
plugin activated: tinkerpop.hadoop
plugin activated: tinkerpop.utilities
plugin activated: janusgraph.imports
plugin activated: tinkerpop.tinkergraph
gremlin&gt; :remote connect tinkerpop.server conf/remote.yaml
==&gt;Connected - localhost/127.0.0.1:8182
gremlin&gt; :&gt; graph.addVertex("name", "stephen")
==&gt;v[256]
gremlin&gt; :&gt; g.V().values('name')
==&gt;stephen</pre><p>The <code class="literal">:remote</code> command tells the console to configure a remote connection to Gremlin Server using the <code class="literal">conf/remote.yaml</code> file to connect.  That file points to a Gremlin Server instance running on <code class="literal">localhost</code>.  The <code class="literal">:&gt;</code> is the "submit" command which sends the Gremlin on that line to the currently active remote. By default remote conenctions are sessionless, meaning that each line sent in the console is interpreted as a single request. Multiple statements can be sent on a single line using a semicolon as the delimiter. Alternately, you can establish a console with a session by specifying <a class="link" href="https://tinkerpop.apache.org/docs/current/reference/#sessions" target="_top">session</a> when creating the connection. A <a class="link" href="https://tinkerpop.apache.org/docs/current/reference/#console-sessions" target="_top">console session</a> allows you to reuse variables across several lines of input.</p><pre class="screen">gremlin&gt; :remote connect tinkerpop.server conf/remote.yaml
==&gt;Configured localhost/127.0.0.1:8182
gremlin&gt; graph
==&gt;standardjanusgraph[cql:[127.0.0.1]]
gremlin&gt; g
==&gt;graphtraversalsource[standardjanusgraph[cql:[127.0.0.1]], standard]
gremlin&gt; g.V()
gremlin&gt; user = "Chris"
==&gt;Chris
gremlin&gt; graph.addVertex("name", user)
No such property: user for class: Script21
Type ':help' or ':h' for help.
Display stack trace? [yN]
gremlin&gt; :remote connect tinkerpop.server conf/remote.yaml session
==&gt;Configured localhost/127.0.0.1:8182-[9acf239e-a3ed-4301-b33f-55c911e04052]
gremlin&gt; g.V()
gremlin&gt; user = "Chris"
==&gt;Chris
gremlin&gt; user
==&gt;Chris
gremlin&gt; graph.addVertex("name", user)
==&gt;v[4344]
gremlin&gt; g.V().values('name')
==&gt;Chris</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_cleaning_up_after_the_pre_packaged_distribution"></a>7.2.&nbsp;Cleaning up after the Pre-Packaged Distribution</h2></div></div></div><p>If you want to start fresh and remove the database and logs you can use the clean command with <code class="literal">janusgraph.sh</code>. The server should be stopped before running the clean operation.</p><pre class="programlisting">$ cd /Path/to/janusgraph/janusgraph-0.2.0-hadoop2/
$ ./bin/janusgraph.sh stop
Killing Gremlin-Server (pid 91505)...
Killing Elasticsearch (pid 91402)...
Killing Cassandra (pid 91219)...
$ ./bin/janusgraph.sh clean
Are you sure you want to delete all stored data and logs? [y/N] y
Deleted data in /Path/to/janusgraph/janusgraph-0.2.0-hadoop2/db
Deleted logs in /Path/to/janusgraph/janusgraph-0.2.0-hadoop2/log</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_janusgraph_server_as_a_websocket_endpoint"></a>7.3.&nbsp;JanusGraph Server as a WebSocket Endpoint</h2></div></div></div><p>The default configuration described in <a class="xref" href="server.html#server-getting-started" title="7.1.&nbsp;Getting Started">Section&nbsp;7.1, &#8220;Getting Started&#8221;</a> is already a WebSocket configuration.  If you want to alter the default configuration to work with your own Cassandra or HBase environment rather than use the quick start environment, follow these steps:</p><div class="orderedlist"><p class="title"><b>To Configure JanusGraph Server For WebSocket</b></p><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">Test a local connection to a JanusGraph database first.  This step applies whether using the Gremlin Console to test the connection, or whether connecting from a program.  Make appropriate changes in a properties file in the <code class="literal">./conf</code> directory for your environment.  For example, edit <code class="literal">./conf/janusgraph-hbase.properties</code> and make sure the storage.backend, storage.hostname and storage.hbase.table parameters are specified correctly.  For more information on configuring JanusGraph for various storage backends, see <a class="xref" href="storage-backends.html" title="Part&nbsp;III.&nbsp;Storage Backends">Part&nbsp;III, &#8220;Storage Backends&#8221;</a>.  Make sure the properties file contains the following line:</p><pre class="screen">gremlin.graph=org.janusgraph.core.JanusGraphFactory</pre></li><li class="listitem"><p class="simpara">Once a local configuration is tested and you have a working properties file, copy the properties file from the <code class="literal">./conf</code> directory to the <code class="literal">./conf/gremlin-server</code> directory.</p><pre class="screen">cp conf/janusgraph-hbase.properties conf/gremlin-server/socket-janusgraph-hbase-server.properties</pre></li><li class="listitem"><p class="simpara">Copy <code class="literal">./conf/gremlin-server/gremlin-server.yaml</code> to a new file called <code class="literal">socket-gremlin-server.yaml</code>.  Do this in case you need to refer to the original version of the file</p><pre class="screen">cp conf/gremlin-server/gremlin-server.yaml conf/gremlin-server/socket-gremlin-server.yaml</pre></li><li class="listitem"><p class="simpara">Edit the <code class="literal">socket-gremlin-server.yaml</code> file and make the following updates:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p class="simpara">If you are planning to connect to JanusGraph Server from something other than localhost, update the IP address for host:</p><pre class="screen">host: 10.10.10.100</pre></li><li class="listitem"><p class="simpara">Update the graphs section to point to your new properties file so the JanusGraph Server can find and connect to your JanusGraph instance:</p><pre class="screen">graphs: {
  graph: conf/gremlin-server/socket-janusgraph-hbase-server.properties}</pre></li></ol></div></li><li class="listitem"><p class="simpara">Start the JanusGraph Server, specifying the yaml file you just configured:</p><pre class="screen">bin/gremlin-server.sh ./conf/gremlin-server/socket-gremlin-server.yaml</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Do not use <code class="literal">bin/janusgraph.sh</code>.  That starts the default configuration, which starts a separate Cassandra/Elasticsearch environment.</p></td></tr></table></div></li><li class="listitem">The JanusGraph Server should now be running in WebSocket mode and can be tested by following the instructions in <a class="xref" href="server.html#first-example-connecting-gremlin-server" title="7.1.1.1.&nbsp;Connecting to Gremlin Server">Section&nbsp;7.1.1.1, &#8220;Connecting to Gremlin Server&#8221;</a></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_janusgraph_server_as_a_http_endpoint"></a>7.4.&nbsp;JanusGraph Server as a HTTP Endpoint</h2></div></div></div><p>The default configuration described in <a class="xref" href="server.html#server-getting-started" title="7.1.&nbsp;Getting Started">Section&nbsp;7.1, &#8220;Getting Started&#8221;</a> is a WebSocket configuration.  If you want to alter the default configuration in order to use JanusGraph Server as an HTTP endpoint for your JanusGraph database, follow these steps:</p><div class="orderedlist"><p class="title"><b>To Configure JanusGraph Server for HTTP</b></p><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">Test a local connection to a JanusGraph database first.  This step applies whether using the Gremlin Console to test the connection, or whether connecting from a program.  Make appropriate changes in a properties file in the <code class="literal">./conf</code> directory for your environment.  For example, edit <code class="literal">./conf/janusgraph-hbase.properties</code> and make sure the storage.backend, storage.hostname and storage.hbase.table parameters are specified correctly.  For more information on configuring JanusGraph for various storage backends, see <a class="xref" href="storage-backends.html" title="Part&nbsp;III.&nbsp;Storage Backends">Part&nbsp;III, &#8220;Storage Backends&#8221;</a>.  Make sure the properties file contains the following line:</p><pre class="screen">gremlin.graph=org.janusgraph.core.JanusGraphFactory</pre></li><li class="listitem"><p class="simpara">Once a local configuration is tested and you have a working properties file, copy the properties file from the <code class="literal">./conf</code> directory to the <code class="literal">./conf/gremlin-server</code> directory.</p><pre class="screen">cp conf/janusgraph-hbase.properties conf/gremlin-server/http-janusgraph-hbase-server.properties</pre></li><li class="listitem"><p class="simpara">Copy <code class="literal">./conf/gremlin-server/gremlin-server.yaml</code> to a new file called <code class="literal">http-gremlin-server.yaml</code>.  Do this in case you need to refer to the original version of the file</p><pre class="screen">cp conf/gremlin-server/gremlin-server.yaml conf/gremlin-server/http-gremlin-server.yaml</pre></li><li class="listitem"><p class="simpara">Edit the <code class="literal">http-gremlin-server.yaml</code> file and make the following updates:</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p class="simpara">If you are planning to connect to JanusGraph Server from something other than localhost, update the IP address for host:</p><pre class="screen">host: 10.10.10.100</pre></li><li class="listitem"><p class="simpara">Update the channelizer setting to specify the HttpChannelizer:</p><pre class="screen">channelizer: org.apache.tinkerpop.gremlin.server.channel.HttpChannelizer</pre></li><li class="listitem"><p class="simpara">Update the graphs section to point to your new properties file so the JanusGraph Server can find and connect to your JanusGraph instance:</p><pre class="screen">graphs: {
  graph: conf/gremlin-server/http-janusgraph-hbase-server.properties}</pre></li></ol></div></li><li class="listitem"><p class="simpara">Start the JanusGraph Server, specifying the yaml file you just configured:</p><pre class="screen">bin/gremlin-server.sh ./conf/gremlin-server/http-gremlin-server.yaml</pre></li><li class="listitem"><p class="simpara">The JanusGraph Server should now be running in HTTP mode and available for testing.  <span class="strong"><strong>curl</strong></span> can be used to verify the server is working:</p><pre class="screen">curl -XPOST -Hcontent-type:application/json -d '{"gremlin":"g.V().count()"}' http://[IP for JanusGraph server host]:8182</pre></li></ol></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_janusgraph_server_as_both_a_websocket_and_http_endpoint"></a>7.5.&nbsp;JanusGraph Server as Both a WebSocket and HTTP Endpoint</h2></div></div></div><p>As of JanusGraph 0.2.0, you can configure your <code class="literal">gremlin-server.yaml</code> to accept both WebSocket and HTTP connections over the same port. This can be achieved by changing the channelizer in any of the previous examples as follows.</p><pre class="screen">channelizer: org.apache.tinkerpop.gremlin.server.channel.WsAndHttpChannelizer</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_advanced_janusgraph_server_configurations"></a>7.6.&nbsp;Advanced JanusGraph Server Configurations</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_authentication_over_http"></a>7.6.1.&nbsp;Authentication over HTTP</h3></div></div></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In the following example, credentialsDb should be different from the graph(s) you are using. It should be configured with the correct backend and a different keyspace, table, or storage directory as appropriate for the configured backend. This graph will be used for storing usernames and passwords.</p></td></tr></table></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_http_basic_authentication"></a>7.6.1.1.&nbsp;HTTP Basic authentication</h4></div></div></div><p>To enable Basic authentication in JanusGraph Server include the following configuration in your <code class="literal">gremlin-server.yaml</code>.</p><pre class="screen"> authentication: {
   authenticator: org.janusgraph.graphdb.tinkerpop.gremlin.server.auth.JanusGraphSimpleAuthenticator,
   authenticationHandler: org.apache.tinkerpop.gremlin.server.handler.HttpBasicAuthenticationHandler,
   config: {
     defaultUsername: user,
     defaultPassword: password,
     credentialsDb: conf/janusgraph-credentials-server.properties
    }
 }</pre><p>Verify that basic authentication is configured correctly. For example</p><pre class="screen">curl -v -XPOST http://localhost:8182 -d '{"gremlin": "g.V().count()"}'</pre><p>should return a 401 if the authentication is configured correctly and</p><pre class="screen">curl -v -XPOST http://localhost:8182 -d '{"gremlin": "g.V().count()"}' -u user:password</pre><p>should return a 200 and the result of 4 if authentication is configured correctly.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_authentication_over_websocket"></a>7.6.2.&nbsp;Authentication over WebSocket</h3></div></div></div><p>Authentication over WebSocket occurs through a Simple Authentication and Security Layer (<a class="link" href="https://en.wikipedia.org/wiki/Simple_Authentication_and_Security_Layer" target="_top">SASL</a>) mechanism.</p><p>To enable SASL authentication include the following configuration in the <code class="literal">gremlin-server.yaml</code></p><pre class="screen">authentication: {
  authenticator: org.janusgraph.graphdb.tinkerpop.gremlin.server.auth.JanusGraphSimpleAuthenticator,
  authenticationHandler: org.apache.tinkerpop.gremlin.server.handler.SaslAuthenticationHandler,
  config: {
    defaultUsername: user,
    defaultPassword: password,
    credentialsDb: conf/janusgraph-credentials-server.properties
  }
}</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In the preceding example, credentialsDb should be different from the graph(s) you are using. It should be configured with the correct backend and a different keyspace, table, or storage directory as appropriate for the configured backend. This graph will be used for storing usernames and passwords.</p></td></tr></table></div><p>If you are connecting through the gremlin console, your remote yaml file should ammend the <code class="literal">username</code> and <code class="literal">password</code> properties with the appropriate values.</p><pre class="screen">username: user
password: password</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_authentication_over_http_and_websocket"></a>7.6.3.&nbsp;Authentication over HTTP and WebSocket</h3></div></div></div><p>If you are using the combined channelizer for both HTTP and WebSocket you can use the SaslAndHMACAuthenticator to authorize through either WebSocket through SASL, HTTP through basic auth, and HTTP through hash-based messsage authentication code (<a class="link" href="https://en.wikipedia.org/wiki/Hash-based_message_authentication_code" target="_top">HMAC</a>) Auth. HMAC is a token based authentication designed to be used over HTTP. You first acquire a token via the <code class="literal">/session</code> endpoint and then use that to authenticate. It is used to amortize the time spent encrypting the password using basic auth.</p><p>The <code class="literal">gremlin-server.yaml</code> should include the following configurations</p><pre class="screen">authentication: {
  authenticator: org.janusgraph.graphdb.tinkerpop.gremlin.server.auth.SaslAndHMACAuthenticator,
  authenticationHandler: org.janusgraph.graphdb.tinkerpop.gremlin.server.handler.SaslAndHMACAuthenticationHandler,
  config: {
    defaultUsername: user,
    defaultPassword: password,
    hmacSecret: secret,
    credentialsDb: conf/janusgraph-credentials-server.properties
  }
}</pre><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>In the preceding example, credentialsDb should be different from the graph(s) you are using. It should be configured with the correct backend and a different keyspace, table, or storage directory as appropriate for the configured backend. This graph will be used for storing usernames and passwords.</p></td></tr></table></div><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Note the hmacSecret here. This should be the same across all running JanusGraph servers if you want to be able to use the same HMAC token on each server.</p></td></tr></table></div><p>For HMAC authentication over HTTP, this creates a <code class="literal">/session</code> endpoint that provides a token that expires after an hour by default. This timeout for the token can be configured through the <code class="literal">tokenTimeout</code> configuration option in the <code class="literal">authentication.config</code> map. This value is a Long value and in milliseconds.</p><p>You can obtain the token using curl by issuing a get request to the <code class="literal">/session</code> endpoint. For example</p><pre class="screen">curl http://localhost:8182/session -XGET -u user:password

{"token": "dXNlcjoxNTA5NTQ2NjI0NDUzOkhrclhYaGhRVG9KTnVSRXJ5U2VpdndhalJRcVBtWEpSMzh5WldqRTM4MW89"}</pre><p>You can then use that token for authentication by using the "Authorization: Token" header. For example</p><pre class="screen">curl -v http://localhost:8182/session -XPOST -d '{"gremlin": "g.V().count()"}' -H "Authorization: Token dXNlcjoxNTA5NTQ2NjI0NDUzOkhrclhYaGhRVG9KTnVSRXJ5U2VpdndhalJRcVBtWEpSMzh5WldqRTM4MW89"</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="gremlin-server-with-janusgraph"></a>7.6.4.&nbsp;Using TinkerPop Gremlin Server with JanusGraph</h3></div></div></div><p>Since JanusGraph Server is a TinkerPop Gremlin Server packaged with configuration files for JanusGraph, a version compatible
TinkerPop Gremlin Server can be downloaded separately and used with JanusGraph.  Get started by <a class="link" href="http://tinkerpop.apache.org/downloads.html" target="_top">downloading</a> the appropriate version of Gremlin Server, which needs to <a class="link" href="version-compat.html" title="Appendix&nbsp;B.&nbsp;Version Compatibility">match a version</a> supported by the JanusGraph version in use (3.3.3).</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>Any references to file paths in this section refer to paths under a TinkerPop distribution for Gremlin Server and not a JanusGraph distribution with the JanusGraph Server, unless specifically noted.</p></td></tr></table></div><p>Configuring a standalone Gremlin Server to work with JanusGraph is similar to configuring the packaged JanusGraph Server. You should be familiar with <a class="link" href="http://tinkerpop.apache.org/docs/3.3.3/reference#_configuring_2" target="_top">graph configuration</a>.  Basically, the Gremlin Server yaml file points to graph-specific configuration files that are used to instantiate <code class="literal">JanusGraph</code> instances that it will then host.  In order to instantiate these <code class="literal">Graph</code> instances, Gremlin Server requires that the appropriate libraries and dependencies for the <code class="literal">JanusGraph</code> be available on its classpath.</p><p>For purposes of demonstration, these instructions will outline how to configure the BerkeleyDB backend for JanusGraph in Gremlin Server. As stated earlier, Gremlin Server needs JanusGraph dependencies on its classpath.  Invoke the following command replacing <code class="literal">$VERSION</code> with the version of JanusGraph to use:</p><pre class="programlisting">bin/gremlin-server.sh -i org.janusgraph janusgraph-all $VERSION</pre><p>When this process completes, Gremlin Server should now have all the JanusGraph dependencies available to it and will thus be able to instantiate <code class="literal">JanusGraph</code> objects.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>The above command uses Groovy Grape and if it is not configured properly download errors may ensue.  Please refer to <a class="link" href="http://tinkerpop.apache.org/docs/3.3.3/reference#gremlin-applications" target="_top">this section</a> of the TinkerPop documentation for more information around setting up <code class="literal">~/.groovy/grapeConfig.xml</code>.</p></td></tr></table></div><p>Create a file called <code class="literal">GREMLIN_SERVER_HOME/conf/janusgraph.properties</code> with the following contents:</p><pre class="programlisting">gremlin.graph=org.janusgraph.core.JanusGraphFactory
storage.backend=berkeleyje
storage.directory=db/berkeley</pre><p>Configuration of other backends is similar.  See <a class="xref" href="storage-backends.html" title="Part&nbsp;III.&nbsp;Storage Backends">Part&nbsp;III, &#8220;Storage Backends&#8221;</a>. If using Cassandra, then use Cassandra configuration options in the <code class="literal">janusgraph.properties</code> file.  The only important piece to leave unchanged is the <code class="literal">gremlin.graph</code> setting which should always use <code class="literal">JanusGraphFactory</code>.  This setting tells Gremlin Server how to instantiate a <code class="literal">JanusGraph</code> instance.</p><p>Next create a file called <code class="literal">GREMLIN_SERVER_HOME/conf/gremlin-server-janusgraph.yaml</code> that has the following contents:</p><pre class="programlisting">host: localhost
port: 8182
graphs: {
  graph: conf/janusgraph.properties}
scriptEngines: {
  gremlin-groovy: {
    plugins: { org.janusgraph.graphdb.tinkerpop.plugin.JanusGraphGremlinPlugin: {},
               org.apache.tinkerpop.gremlin.server.jsr223.GremlinServerGremlinPlugin: {},
               org.apache.tinkerpop.gremlin.tinkergraph.jsr223.TinkerGraphGremlinPlugin: {},
               org.apache.tinkerpop.gremlin.jsr223.ImportGremlinPlugin: {classImports: [java.lang.Math], methodImports: [java.lang.Math#*]},
               org.apache.tinkerpop.gremlin.jsr223.ScriptFileGremlinPlugin: {files: [scripts/empty-sample.groovy]}}}}
serializers:
  - { className: org.apache.tinkerpop.gremlin.driver.ser.GryoMessageSerializerV3d0, config: { ioRegistries: [org.janusgraph.graphdb.tinkerpop.JanusGraphIoRegistry] }}
  - { className: org.apache.tinkerpop.gremlin.driver.ser.GryoMessageSerializerV3d0, config: { serializeResultToString: true }}
  - { className: org.apache.tinkerpop.gremlin.driver.ser.GraphSONMessageSerializerV3d0, config: { ioRegistries: [org.janusgraph.graphdb.tinkerpop.JanusGraphIoRegistry] }}
metrics: {
  slf4jReporter: {enabled: true, interval: 180000}}</pre><div class="orderedlist"><p class="title"><b>There are several important parts to this configuration file as they relate to JanusGraph.</b></p><ol class="orderedlist" type="1"><li class="listitem">In the <code class="literal">graphs</code> map, there is a key called <code class="literal">graph</code> and its value is <code class="literal">conf/janusgraph.properties</code>.  This tells Gremlin Server to instantiate a <code class="literal">Graph</code> instance called "graph" and use the <code class="literal">conf/janusgraph.properties</code> file to configure it.  The "graph" key becomes the unique name for the <code class="literal">Graph</code> instance in Gremlin Server and it can be referenced as such in the scripts submitted to it.</li><li class="listitem">In the <code class="literal">plugins</code> list, there is a reference to <code class="literal">JanusGraphGremlinPlugin</code>, which tells Gremlin Server to initialize the "JanusGraph Plugin".  The "JanusGraph Plugin" will auto-import JanusGraph specific classes for usage in scripts.</li><li class="listitem">Note the <code class="literal">scripts</code> key and the reference to <code class="literal">scripts/janusgraph.groovy</code>.  This Groovy file is an initialization script for Gremlin Server and that particular ScriptEngine.  Create <code class="literal">scripts/janusgraph.groovy</code> with the following contents:</li></ol></div><pre class="programlisting">def globals = [:]
globals &lt;&lt; [g : graph.traversal()]</pre><p>The above script creates a <code class="literal">Map</code> called <code class="literal">globals</code> and assigns to it a key/value pair.  The key is <code class="literal">g</code> and its value is a <code class="literal">TraversalSource</code> generated from <code class="literal">graph</code>, which was configured for Gremlin Server in its configuration file. At this point, there are now two global variables available to scripts provided to Gremlin Server - <code class="literal">graph</code> and <code class="literal">g</code>.</p><p>At this point, Gremlin Server is configured and can be used to connect to a new or existing JanusGraph database.  To start the server:</p><pre class="programlisting">$ bin/gremlin-server.sh conf/gremlin-server-janusgraph.yaml
[INFO] GremlinServer -
         \,,,/
         (o o)
-----oOOo-(<span class="hl-number">3</span>)-oOOo-----

[INFO] GremlinServer - Configuring Gremlin Server from conf/gremlin-server-janusgraph.yaml
[INFO] MetricManager - Configured Metrics Slf4jReporter configured with interval=<span class="hl-number">180000</span>ms and loggerName=org.apache.tinkerpop.gremlin.server.Settings$Slf4jReporterMetrics
[INFO] GraphDatabaseConfiguration - Set default timestamp provider MICRO
[INFO] GraphDatabaseConfiguration - Generated unique-instance-id=<span class="hl-number">7</span>f0000016240-ubuntu1
[INFO] Backend - Initiated backend operations thread pool of size <span class="hl-number">8</span>
[INFO] KCVSLog$MessagePuller - Loaded unidentified ReadMarker start time <span class="hl-number">2015</span>-<span class="hl-number">10</span>-<span class="hl-number">02</span>T12:<span class="hl-number">28</span>:<span class="hl-number">24.411</span>Z into org.janusgraph.diskstorage.log.kcvs.KCVSLog$MessagePuller@<span class="hl-number">35399441</span>
[INFO] GraphManager - Graph [graph] was successfully configured via [conf/janusgraph.properties].
[INFO] ServerGremlinExecutor - Initialized Gremlin thread pool.  Threads in pool named with pattern gremlin-*
[INFO] ScriptEngines - Loaded gremlin-groovy ScriptEngine
[INFO] GremlinExecutor - Initialized gremlin-groovy ScriptEngine with scripts/janusgraph.groovy
[INFO] ServerGremlinExecutor - Initialized GremlinExecutor and configured ScriptEngines.
[INFO] ServerGremlinExecutor - A GraphTraversalSource is now bound to [g] with graphtraversalsource[standardjanusgraph[berkeleyje:db/berkeley], standard]
[INFO] AbstractChannelizer - Configured application/vnd.gremlin-v3.<span class="hl-number">0</span>+gryo with org.apache.tinkerpop.gremlin.driver.ser.GryoMessageSerializerV3d0
[INFO] AbstractChannelizer - Configured application/vnd.gremlin-v3.<span class="hl-number">0</span>+gryo-stringd with org.apache.tinkerpop.gremlin.driver.ser.GryoMessageSerializerV3d0
[INFO] GremlinServer$<span class="hl-number">1</span> - Gremlin Server configured with worker thread pool of <span class="hl-number">1</span>, gremlin pool of <span class="hl-number">8</span> and boss thread pool of <span class="hl-number">1.</span>
[INFO] GremlinServer$<span class="hl-number">1</span> - Channel started at port <span class="hl-number">8182</span>.</pre><p>The following section explains how to connect to the running server.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_connecting_to_janusgraph_via_gremlin_server"></a>7.6.4.1.&nbsp;Connecting to JanusGraph via Gremlin Server</h4></div></div></div><p>Gremlin Server will be ready to listen for WebSocket connections when it is started.  The easiest way to test the connection is with Gremlin Console.</p><p>Follow the instructions here  <a class="xref" href="server.html#first-example-connecting-gremlin-server" title="7.1.1.1.&nbsp;Connecting to Gremlin Server">Section&nbsp;7.1.1.1, &#8220;Connecting to Gremlin Server&#8221;</a> to verify the Gremlin Server is working.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/important.png"></td><th align="left">Important</th></tr><tr><td align="left" valign="top"><p>A difference you should understand is that when working with JanusGraph Server, the Gremlin Console is started from underneath the JanusGraph distribution and when following the test instructions here for a standalone Gremlin Server, the Gremlin Console is started from under the TinkerPop distribution.</p></td></tr></table></div><pre class="programlisting">GryoMapper mapper = GryoMapper.build().addRegistry(JanusGraphIoRegistry.INSTANCE).create();
Cluster cluster = Cluster.build().serializer(<strong class="hl-keyword">new</strong> GryoMessageSerializerV3d0(mapper)).create();
Client client = cluster.connect();
client.submit(<span class="hl-string">"g.V()"</span>).all().get();</pre><p>By adding the <code class="literal">JanusGraphIoRegistry</code> to the <code class="literal">org.apache.tinkerpop.gremlin.driver.ser.GryoMessageSerializerV3d0</code>, the driver will know how to properly deserialize custom data types returned by JanusGraph.</p></div></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_extending_janusgraph_server"></a>7.7.&nbsp;Extending JanusGraph Server</h2></div></div></div><p>It is possible to extend Gremlin Server with other means of communication by implementing the interfaces that it provides and leverage this with JanusGraph.  See more details in the appropriate TinkerPop documentation.</p></div></div></div><div class="clearer"></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="gremlin.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="basics.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="deployment-scenarios.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;6.&nbsp;Gremlin Query Language&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;8.&nbsp;Deployment Scenarios</td></tr></table></div><div class="footer-wrapper"><footer id="footer"><div class="copyright">
              Copyright &copy; 2017 JanusGraph Authors. All rights reserved.<br>
              The Linux Foundation has registered trademarks and uses trademarks. For a list of<br>
              trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage</a> page.<br>
              Cassandra, Groovy, HBase, Hadoop, Lucene, Solr, and TinkerPop are trademarks of the Apache Software Foundation.<br>
              Berkeley DB and Berkeley DB Java Edition are trademarks of Oracle.<br>
              Documentation generated with <a href="http://www.methods.co.nz/asciidoc/">AsciiDoc</a>, <a href="http://asciidoctor.org/">AsciiDoctor</a>, <a href="http://docbook.sourceforge.net/">DocBook</a>, and <a href="http://saxon.sourceforge.net/">Saxon</a>.
        	  </div></footer></div></div></body></html>