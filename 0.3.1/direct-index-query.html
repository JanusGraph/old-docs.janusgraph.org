<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;26.&nbsp;Direct Index Query</title><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="JanusGraph Documentation"><link rel="up" href="index-backends.html" title="Part&nbsp;IV.&nbsp;Index Backends"><link rel="prev" href="field-mapping.html" title="Chapter&nbsp;25.&nbsp;Field Mapping"><link rel="next" href="elasticsearch.html" title="Chapter&nbsp;27.&nbsp;Elasticsearch"><script xmlns:d="http://docbook.org/ns/docbook" type="text/javascript" src="js/jquery/jquery-1.11.0.js"></script><script xmlns:d="http://docbook.org/ns/docbook" type="text/javascript" src="js/jquery/jquery-migrate-1.2.1.min.js"></script><link xmlns:d="http://docbook.org/ns/docbook" rel="stylesheet" id="inline-blob-janusgraph-docs-specific" href="css/docs.css" type="text/css" media="all"><link xmlns:d="http://docbook.org/ns/docbook" rel="apple-touch-icon" type="image/png" href="images/janusgraph-logomark.png"><script xmlns:d="http://docbook.org/ns/docbook" type="text/javascript">
      WebFontConfig = {
        google: {
          families: [
            "Lato:400,400italic,700,700italic:latin,greek-ext,cyrillic,latin-ext,greek,cyrillic-ext,vietnamese",
            "Open+Sans:400,400italic,700,700italic:latin,greek-ext,cyrillic,latin-ext,greek,cyrillic-ext,vietnamese",
            "Antic+Slab:400,400italic,700,700italic:latin,greek-ext,cyrillic,latin-ext,greek,cyrillic-ext,vietnamese"
          ]
        }
      };
      (function() {
      var wf = document.createElement('script');
      wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
        '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
	wf.type = 'text/javascript';
	wf.async = 'true';
	var s = document.getElementsByTagName('script')[0];
	s.parentNode.insertBefore(wf, s);
	})();
    </script></head><body xmlns:d="http://docbook.org/ns/docbook" bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div id="wrapper"><div class="header-wrapper"><header id="header"><ul class="header-list"><li class="header-item"><a href="http://janusgraph.org"><img src="images/janusgraph-logo.png" alt="JanusGraph" class="normal_logo"></a></li><li class="header-item-right"><a href="https://github.com/JanusGraph/janusgraph/releases">Download JanusGraph</a></li><li class="header-item-right dropdown"><a href="https://docs.janusgraph.org/latest/doc-versions.html">Other Doc Versions</a><div class="dropdown-content"><a href="https://docs.janusgraph.org/latest/index.html">Latest</a><a href="https://docs.janusgraph.org/0.3.1/index.html">Version 0.3.1</a><a href="https://docs.janusgraph.org/0.3.0/index.html">Version 0.3.0</a><a href="https://docs.janusgraph.org/0.2.2/index.html">Version 0.2.2</a><a href="https://docs.janusgraph.org/0.2.1/index.html">Version 0.2.1</a><a href="https://docs.janusgraph.org/0.2.0/index.html">Version 0.2.0</a><a href="https://docs.janusgraph.org/0.1.1/index.html">Version 0.1.1</a><a href="https://docs.janusgraph.org/0.1.0/index.html">Version 0.1.0</a></div></li><li class="header-item-right"><a href="index.html">Documentation (0.3.1)</a></li></ul></header></div><div id="main" class="clearfix width-100"><div class="breadcrumbs"><span class="breadcrumb-link"><a href="index.html">JanusGraph Documentation</a></span> &gt; <span class="breadcrumb-link"><a href="index-backends.html">Index Backends</a></span> &gt; <span class="breadcrumb-node">Direct Index Query</span></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a name="direct-index-query"></a>Chapter&nbsp;26.&nbsp;Direct Index Query</h2></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="direct-index-query.html#_query_string">26.1. Query String</a></span></dt><dt><span class="section"><a href="direct-index-query.html#_query_totals">26.2. Query Totals</a></span></dt><dt><span class="section"><a href="direct-index-query.html#_gotchas">26.3. Gotchas</a></span></dt><dd><dl><dt><span class="section"><a href="direct-index-query.html#_property_key_names">26.3.1. Property Key Names</a></span></dt><dt><span class="section"><a href="direct-index-query.html#_element_identifier_collision">26.3.2. Element Identifier Collision</a></span></dt><dt><span class="section"><a href="direct-index-query.html#_mixed_index_availability_delay">26.3.3. Mixed Index Availability Delay</a></span></dt></dl></dd></dl></div><p>JanusGraph&#8217;s standard global graph querying mechanism supports boolean queries for vertices or edges. In other words, an element either matches the query or it does not. There are no partial matches or result scoring.</p><p>Some indexing backends additionally support fuzzy search queries. For those queries, a score is computed for each match to indicate the "goodness" of the match and results are returned in the order of their score. Fuzzy search is particularly useful when dealing with full-text search queries where matching more words is considered to be better.</p><p>Since fuzzy search implementations and scoring algorithms differ significantly between indexing backends, JanusGraph does not support fuzzy search natively. However, JanusGraph provides a <span class="emphasis"><em>direct index query</em></span> mechanism that allows search queries to be directly send to the indexing backend for evaluation (for those backends that support it).</p><p>Use <code class="literal">Graph.indexQuery()</code> to compose a query that is executed directly against an indexing backend. This query builder expects two parameters:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">The name of the indexing backend to query. This must be the name configured in JanusGraph&#8217;s configuration and used in the property key indexing definitions</li><li class="listitem">The query string</li></ol></div><p>The builder allows configuration of the maximum number of elements to be returned via its <code class="literal">limit(int)</code> method.  The builder&#8217;s <code class="literal">offset(int)</code> controls number of initial matches in the result set to skip. To retrieve all vertex or edges matching the given query in the specified indexing backend, invoke <code class="literal">vertices()</code> or <code class="literal">edges()</code>, respectively. It is not possible to query for both vertices and edges at the same time.
These methods return an <code class="literal">Iterable</code> over <code class="literal">Result</code> objects. A result object contains the matched handle, retrievable via <code class="literal">getElement()</code>, and the associated score - <code class="literal">getScore()</code>.</p><p>Consider the following example:</p><pre class="programlisting">ManagementSystem mgmt = graph.openManagement();
PropertyKey text = mgmt.makePropertyKey(<span class="hl-string">"text"</span>).dataType(String.<strong class="hl-keyword">class</strong>).make();
mgmt.buildIndex(<span class="hl-string">"vertexByText"</span>, Vertex.<strong class="hl-keyword">class</strong>).addKey(text).buildMixedIndex(<span class="hl-string">"search"</span>);
mgmt.commit();
<em class="hl-comment">// ... Load vertices ...</em>
<strong class="hl-keyword">for</strong> (Result&lt;Vertex&gt; result : graph.indexQuery(<span class="hl-string">"vertexByText"</span>, <span class="hl-string">"v.text:(farm uncle berry)"</span>).vertices()) {
   System.out.println(result.getElement() + <span class="hl-string">": "</span> + result.getScore());
}</pre><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_query_string"></a>26.1.&nbsp;Query String</h2></div></div></div><p>The query string is handed directly to the indexing backend for processing and hence the query string syntax depends on what is supported by the indexing backend. For vertex queries, JanusGraph will analyze the query string for property key references starting with "v." and replace those by a handle to the indexing field that corresponds to the property key. Likewise, for edge queries, JanusGraph will replace property key references starting with "e.".
Hence, to refer to a property of a vertex, use "v.[KEY_NAME]" in the query string. Likewise, for edges write "e.[KEY_NAME]".</p><p><a class="link" href="elasticsearch.html" title="Chapter&nbsp;27.&nbsp;Elasticsearch">Elasticsearch</a> and <a class="link" href="lucene.html" title="Chapter&nbsp;29.&nbsp;Apache Lucene">Lucene</a> support the <a class="link" href="http://lucene.apache.org/core/4_10_4/queryparser/org/apache/lucene/queryparser/classic/package-summary.html" target="_top">Lucene query syntax</a>. Refer to the <a class="link" href="http://lucene.apache.org/core/4_1_0/queryparser/org/apache/lucene/queryparser/classic/package-summary.html" target="_top">Lucene documentation</a> or the <a class="link" href="http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html" target="_top">Elasticsearch documentation</a> for more information. The query used in the example above follows the Lucene query syntax.</p><pre class="programlisting">graph.indexQuery(<span class="hl-string">"vertexByText"</span>, <span class="hl-string">"v.text:(farm uncle berry)"</span>).vertices()</pre><p>This query matches all vertices where the text contains any of the three words (grouped by parentheses) and score matches higher the more words are matched in the text.</p><p>In addition <a class="link" href="elasticsearch.html" title="Chapter&nbsp;27.&nbsp;Elasticsearch">Elasticsearch</a> supports wildcard queries, use "v.*" or "e.*" in the query string to query if any of the properties on the element match.</p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_query_totals"></a>26.2.&nbsp;Query Totals</h2></div></div></div><p>It is sometimes useful to know how many total results were returned from a query without having to retrieve all results.  Fortunately, Elasticsearch and Solr provide a shortcut that does not involve retrieving and ranking all documents.  This shortcut is exposed through the ".vertexTotals()", ".edgeTotals()", and ".propertyTotals()" methods.</p><p>The totals can be retrieved using the same query syntax as the indexQuery builder, but size is overwritten to be 0.</p><pre class="programlisting">graph.indexQuery(<span class="hl-string">"vertexByText"</span>, <span class="hl-string">"v.text:(farm uncle berry)"</span>).vertexTotals()</pre></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_gotchas"></a>26.3.&nbsp;Gotchas</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_property_key_names"></a>26.3.1.&nbsp;Property Key Names</h3></div></div></div><p>Names of property keys that contain non-alphanumeric characters must be placed in quotation marks to ensure that the query is parsed correctly.</p><pre class="programlisting">graph.indexQuery(<span class="hl-string">"vertexByText"</span>, <span class="hl-string">"v.\"first_name\":john"</span>).vertices()</pre><p>Some property key names may be transformed by the JanusGraph indexing backend implementation. For instance, an indexing backend that does not permit spaces in field names may transform "My Field Name" to "My&#8226;Field&#8226;Name", or an indexing backend like Solr may append type information to the name, transforming "myBooleanField" to "myBooleanField_b". These transformations happen in the index backend&#8217;s implementation of IndexProvider, in the "mapKey2Field" method. Indexing backends may reserve special characters (such as <span class="emphasis"><em>&#8226;</em></span>) and prohibit indexing of fields that contain them. For this reason it is recommended to avoid spaces and special characters in property names.</p><p>In general, making direct index queries depends on implementation details of JanusGraph indexing backends that are normally hidden from users, so it&#8217;s best to verify a query empirically against the indexing backend in use.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_element_identifier_collision"></a>26.3.2.&nbsp;Element Identifier Collision</h3></div></div></div><p>The strings "v.", "e.", and "p." are used to identify a vertex, edge or property element respectively in a query. If the field name or the query value contains the same sequence of characters, this can cause a collision in the query string and parsing errors as in the following example:</p><pre class="programlisting">graph.indexQuery(<span class="hl-string">"vertexByText"</span>, <span class="hl-string">"v.name:v.john"</span>).vertices() <em class="hl-comment">//DOES NOT WORK!</em></pre><p>To avoid such identifier collisions, use the <code class="literal">setElementIdentifier</code> method to define a unique element identifier string that does not occur in any other parts of the query:</p><pre class="programlisting">graph.indexQuery(<span class="hl-string">"vertexByText"</span>, <span class="hl-string">"$v$name:v.john"</span>).setElementIdentifier(<span class="hl-string">"$v$"</span>).vertices()</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_mixed_index_availability_delay"></a>26.3.3.&nbsp;Mixed Index Availability Delay</h3></div></div></div><p>When a query traverses a <a class="link" href="indexes.html#index-mixed" title="11.1.2.&nbsp;Mixed Index">mixed index</a> immediately after data is inserted the changes may not be visible. In <a class="link" href="elasticsearch.html" title="Chapter&nbsp;27.&nbsp;Elasticsearch">Elasticsearch</a> the configuration option that determines this delay is <a class="link" href="https://www.elastic.co/guide/en/elasticsearch/reference/5.4/index-modules.html#dynamic-index-settings" target="_top">index refresh interval</a>. In <a class="link" href="solr.html" title="Chapter&nbsp;28.&nbsp;Apache Solr">Solr</a> the primary configuration option is <a class="link" href="https://lucene.apache.org/solr/guide/6_6/near-real-time-searching.html" target="_top">max time</a>.</p></div></div></div></div><div class="clearer"></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="field-mapping.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="index-backends.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="elasticsearch.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;25.&nbsp;Field Mapping&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;27.&nbsp;Elasticsearch</td></tr></table></div><div class="footer-wrapper"><footer id="footer"><div class="copyright">
              Copyright &copy; 2017 JanusGraph Authors. All rights reserved.<br>
              The Linux Foundation has registered trademarks and uses trademarks. For a list of<br>
              trademarks of The Linux Foundation, please see our <a href="https://www.linuxfoundation.org/trademark-usage">Trademark Usage</a> page.<br>
              Cassandra, Groovy, HBase, Hadoop, Lucene, Solr, and TinkerPop are trademarks of the Apache Software Foundation.<br>
              Berkeley DB and Berkeley DB Java Edition are trademarks of Oracle.<br>
              Documentation generated with <a href="http://www.methods.co.nz/asciidoc/">AsciiDoc</a>, <a href="http://asciidoctor.org/">AsciiDoctor</a>, <a href="http://docbook.sourceforge.net/">DocBook</a>, and <a href="http://saxon.sourceforge.net/">Saxon</a>.
        	  </div></footer></div></div></body></html>